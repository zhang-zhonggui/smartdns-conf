name: Update China List for SmartDNS

on:
  schedule:
    # 北京时间每天早上 6 点运行 (UTC 22:00)
    - cron: '0 22 * * *'
  workflow_dispatch: # 允许手动点击按钮运行
  
  # 修改：当 push 代码时自动运行
  push:
    paths:
      - 'mylist.txt'            # 只有当自定义列表变动时运行
      - '.github/workflows/**'  # 或者当你修改这个脚本时运行
    # 删除了 paths-ignore，因为上面指定了 paths 后，
    # 改动 chinalist.txt 这种不在列表里的文件，本身就不会触发运行，
    # 这样就自动避免了死循环。

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Download, Merge and Convert
        run: |
          # 1. 下载官方源文件
          wget https://raw.githubusercontent.com/felixonmars/dnsmasq-china-list/master/accelerated-domains.china.conf -O raw.conf

          # 2. 提取官方列表中的纯域名 (暂存到 temp_official.txt)
          # awk 依然负责提取 server=/xxx/ 中的 xxx
          awk -F/ '/^server=\// {print $2}' raw.conf > temp_official.txt

          # 3. 合并逻辑：将 官方列表 和 你的 mylist.txt 合并
          # 判断一下 mylist.txt 是否存在，防止报错
          if [ -f "mylist.txt" ]; then
            echo "检测到 mylist.txt，正在合并..."
            # 将两个文件内容拼在一起，然后用 sort -u 进行【排序并去重】
            cat temp_official.txt mylist.txt | sort -u > chinalist.txt
          else
            echo "未检测到 mylist.txt，仅生成官方列表..."
            sort -u temp_official.txt > chinalist.txt
          fi

          # 4. 清理临时文件 (保留生成的 chinalist.txt)
          rm raw.conf temp_official.txt

          # 5. 检查文件内容 (方便在 Action 日志里看一眼)
          echo "生成行数统计:"
          wc -l chinalist.txt
          echo "前5行内容:"
          head -n 5 chinalist.txt

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add chinalist.txt
          # 只有当生成的文件和仓库里现有的不一样时，才提交
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update chinalist.txt (Official + Custom)" && git push)
